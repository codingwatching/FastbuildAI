const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DH0fxYWa.js","./n4aLOYdS.js","./4jjeIyfe.js","./D_3bTjYR.js","./D9sX2Qi6.js","./C4S285vI.js","./BTN3Ax-V.js","./BKdtdX-7.js","./CtosDvS0.js","./kRIii9yh.js","./DxD6Ynfo.js","./BhB8DUPm.js","./C6Y-ieo6.js","./zlMhJk0P.js","./DeCyaT7k.js","./D4e4FYoF.js","./BCcN9pii.js","./CMKSl-Ng.js","./CuVAPZQ8.js","./psimjGaX.js","./B3rWqoNg.js","./EK7Wbu3-.js","./BjKIBNOf.js","./DWy_CFG9.js","./td2xDKru.js","./BMSQkwth.js","./DaWZu8wl.js","./bvMLy1sv.js","./CAQVAH0V.js","./Deu6qIfg.js","./BtLy_Oaq.js","./D19QCKnC.js","./LSmoYDCw.js","./B3XNqw4u.js","./BVraOlsu.js","./BxwUS5gW.js","./MCK2d4XT.js","./meHCBXcx.js","./D2M85Dwf.js","./FTderXKt.js","./DpytHuLS.js","./BkF8DltG.js","./jsPNKUA0.js","./Bzv9SrOl.js","./DvNezYYM.js","./cd55qm53.js","./CBP5wIdr.js","./BstbYvQo.js"])))=>i.map(i=>d[i]);
import{d as ve,aM as he,j as O,i as _e,at as ke,k as ye,aR as be,V as Ce,n as Q,s as T,aW as we,p as xe,J as z,q as Ie,ai as Se,c as l,o as r,f as k,y as f,t as d,x as g,g as a,W as U,w as v,z as y,F,E as L,_ as Ee,B as Fe,D as N,X as P,aZ as Ae}from"#entry";import{_ as Re}from"./B_l_nphw.js";import{_ as Ve,a as $e}from"./Omr6x9Yj.js";import{_ as Be}from"./shdu-Ndv.js";import{_ as Me}from"./Dl_TiQPG.js";import{_ as Te}from"./BkF8DltG.js";import{_ as Ue}from"./DWe_-2t3.js";import{p as Le,o as Pe}from"./meHCBXcx.js";import{u as qe}from"./CKZGjRTU.js";import"./BMSQkwth.js";import"./DaWZu8wl.js";import"./Bzv9SrOl.js";import"./Y499mysc.js";import"./o4ws_w_T.js";import"./CCoSr_X_.js";import"./DxD6Ynfo.js";import"./psimjGaX.js";import"./CuVAPZQ8.js";import"./B3rWqoNg.js";import"./EK7Wbu3-.js";import"./RPflLnqr.js";import"./TrJvDfxI.js";import"./jsPNKUA0.js";import"./CIl2WAVV.js";import"./Brot9FFj.js";import"./B1clvDFJ.js";import"./DBiaUVBh.js";import"./Be9qZ8Md.js";import"./BKdtdX-7.js";import"./CtosDvS0.js";import"./kRIii9yh.js";import"./BhB8DUPm.js";import"./C6Y-ieo6.js";import"./zlMhJk0P.js";import"./DeCyaT7k.js";import"./D4e4FYoF.js";import"./BCcN9pii.js";import"./CMKSl-Ng.js";import"./CxvgZo8z.js";import"./4jjeIyfe.js";import"./cd55qm53.js";import"./C457VaE0.js";import"./fhkze2Jn.js";import"./DWy_CFG9.js";import"./td2xDKru.js";import"./BEK00iAE.js";const De={class:"flex h-full min-h-0 w-full flex-col"},Oe={key:0,class:"flex flex-col gap-2"},Qe={class:"text-muted-foreground text-sm"},ze={key:0,class:"flex items-center gap-2"},Ne={class:"my-2 flex items-center gap-1"},He={class:"text-muted-foreground flex-none text-xs"},je={key:1,class:"mt-2 flex items-center gap-1"},We={class:"text-muted-foreground flex-none text-xs"},Je={key:0,class:"m-2 space-y-2"},Ke={class:"px-4 pb-4"},Xe={class:"flex gap-2 pb-4"},Nt=ve({__name:"preview-chat",props:{agent:{},showVariableInput:{type:Boolean}},emits:["update:agent"],setup(c,{expose:H,emit:j}){const W=U(()=>P(()=>import("./DH0fxYWa.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39]),import.meta.url)),J=U(()=>P(()=>import("./DpytHuLS.js"),__vite__mapDeps([40,41,1,42,43,31,32,33,13,18,11,34,35,36,21]),import.meta.url)),K=U(()=>P(()=>import("./DvNezYYM.js"),__vite__mapDeps([44,45,1,3,4,2,46,8,28,10,13,14,15,11,47,18,30,39,26]),import.meta.url)),X=j,Z=c,{params:G}=he(),Y=O(),{t:s}=_e(),x=ke(),b=ye("scrollAreaRef"),{height:ee}=be(b),q=Ce(),o=we(Z,"agent",X),I=Q(()=>G.id),A=T(null),te=[],ne=T([]),{messages:u,input:R,files:V,handleSubmit:ae,reload:oe,stop:re,status:se,error:ie}=qe({api:Le,initialMessages:te,chatConfig:{get avatar(){return o.value.chatAvatar}},body:{agentId:I.value,saveConversation:!1,get conversationId(){return A.value},get modelConfig(){return o.value.modelConfig},get mcpServerIds(){return o.value.mcpServerIds},get datasetIds(){return o.value.datasetIds},get rolePrompt(){return o.value.rolePrompt},get showContext(){return o.value.showContext},get showReference(){return o.value.showReference},get enableFeedback(){return o.value.enableFeedback},get autoQuestions(){return o.value.autoQuestions},get formFields(){return o.value.formFields},get formFieldsInputs(){return o.value.formFieldsInputs},get quickCommands(){return o.value.quickCommands},get thirdPartyIntegration(){return o.value.thirdPartyIntegration}},onToolCall(){},onResponse(n){n.status===401&&O().logout(!0)},onUpdate(n){n.type==="conversation_id"&&(A.value=n.data)},onError(n){const t=n?.message||"发送失败";console.error("聊天错误:",t)},onFinish(){}}),S=Q(()=>se.value==="loading"),$=T(!0);function B(n){const t=n.target,m=40;$.value=t.scrollHeight-(t.scrollTop+t.clientHeight)<=m}async function C(n=!0){await z(),b.value?.scrollToBottom(n)}async function E(n){if(!n.trim()||S.value)return;if(!o.value.modelConfig?.id&&o.value.createMode==="direct")return x.warning(s("ai-agent.backend.configuration.modelNotConfigured"));const t=o.value.formFields||[],m=o.value.formFieldsInputs||{};if(t.length>0){const i=[];if(t.forEach(_=>{if(_.required){const w=m[_.name];(!w||typeof w=="string"&&w.trim()==="")&&i.push(`${_.label}${s("ai-agent.backend.configuration.notEmpty")}`)}}),i.length>0){x.error(`${s("ai-agent.backend.configuration.formVariableTitle")}: ${i.join(", ")}`);return}}await ae(n),C()}const le=n=>{ne.value=n,q.create(J).open({context:n})},ce=(n,t=null)=>{q.create(W).open({agentId:I.value,annotationId:n,messageId:t,hiddenStatus:!0})};async function ue(n,t){const m=u.value[t-1];if(!m||m.role!=="user"){x.error(s("ai-agent.backend.configuration.noUserQuestion"));return}try{const i=await Pe(I.value,{agentId:I.value,question:m.content.toString(),answer:n.content.toString(),enabled:!0,messageId:n.id});u.value[t]?.metadata||u.value[t]&&(u.value[t].metadata={}),u.value[t]?.metadata&&(u.value[t].metadata.annotations={annotationId:i.id,createdBy:Y.userInfo?.nickname,question:i.question,similarity:1})}catch(i){console.error("创建标注失败:",i)}}xe(()=>u.value.at(-1)?.content,()=>z(()=>{$.value&&C(!1)}),{flush:"post"});let M=null;return Ie(async()=>{C(!1);const n=b.value?.getViewportElement(),t=n&&n.viewportElement;t?.addEventListener("scroll",B,{passive:!0}),t&&(B({target:t}),M=new MutationObserver(()=>{$.value&&C(!1)}),M.observe(t,{childList:!0,subtree:!0,characterData:!0}))}),Se(()=>{const n=b.value?.getViewportElement();(n&&n.viewportElement)?.removeEventListener("scroll",B),M?.disconnect()}),H({clearRecord(){u.value=[],A.value=null}}),(n,t)=>{const m=Re,i=Ee,_=$e,w=Fe,D=Be,me=Me,de=Ve,fe=Te,pe=Ae,ge=Ue;return r(),l("div",De,[c.showVariableInput&&a(o).formFields&&a(o).formFields.length>0?(r(),k(a(K),{key:0,inputs:a(o).formFieldsInputs,"onUpdate:inputs":t[0]||(t[0]=e=>a(o).formFieldsInputs=e),formFields:a(o).formFields,class:"mx-4 mt-2",formClass:"bg-muted hover:bg-muted"},null,8,["inputs","formFields"])):f("",!0),d(fe,{class:"min-h-0 w-full flex-1",type:"auto",ref_key:"scrollAreaRef",ref:b,onInView:t[1]||(t[1]=e=>C(!1))},{default:v(()=>[d(de,{loading:!1,"has-more":!1,threshold:500,"content-class":"w-full space-y-3 p-4 "},{default:v(()=>[a(u).length===0?(r(),k(_,{key:0,messages:[{role:"assistant",avatar:c.agent.chatAvatar,content:c.agent.openingStatement}],"scroll-area-height":200,assistant:{actions:[]}},{content:v(({message:e})=>[d(m,{content:e.content.toString(),class:"mb-2"},null,8,["content"]),c.agent.openingQuestions.length>0?(r(),l("div",Oe,[g("div",Qe,y(a(s)("ai-agent.backend.configuration.youCanAskMe")),1),(r(!0),l(F,null,L(c.agent.openingQuestions,p=>(r(),l("div",{key:p},[d(i,{label:p,color:"primary",variant:"soft",onClick:h=>E(p)},null,8,["label","onClick"])]))),128))])):f("",!0)]),_:1},8,["messages"])):(r(),k(_,{key:1,messages:a(u),"scroll-area-height":a(ee),error:a(ie),assistant:{actions:[{label:a(s)("ai-chat.frontend.messages.retry"),icon:"i-lucide-rotate-cw-square",onClick:()=>a(oe)()},{label:a(s)("ai-agent.backend.configuration.chatContext"),icon:"i-lucide-file-type",show:!c.agent.showContext,onClick:e=>{e?.metadata?.context?le(e.metadata.context):a(x).error(a(s)("ai-agent.backend.configuration.noChatContext"))}},{label:a(s)("ai-agent.backend.configuration.feedback"),icon:"i-lucide-wrap-text",show:!c.agent.enableFeedback,onClick:(e,p)=>{const h=e.metadata?.annotations?.annotationId;h?ce(h,e.id):ue(e,p)}}]},"spacing-offset":160},{content:v(({message:e})=>[e.content.length||e.metadata?.references&&e.metadata.references.length?(r(),k(m,{key:0,content:e.content.toString()},{before:v(()=>[e.status==="loading"?(r(),l("div",ze,[d(w,{name:"i-lucide-loader-2",class:"animate-spin"}),g("span",null,y(a(s)("ai-chat.frontend.messages.thinking")),1)])):f("",!0)]),after:v(()=>[e.metadata?.references&&e.metadata.references.length>0&&e.role==="assistant"&&!a(S)&&c.agent.showReference?(r(),l(F,{key:0},[g("div",Ne,[g("span",He,y(a(s)("ai-agent.backend.configuration.referenceTitle")),1),e.metadata?.references&&e.metadata.references.length>0&&e.role==="assistant"?(r(),k(D,{key:0,size:"xs",type:"dashed"})):f("",!0)]),d(me,{references:e.metadata.references},null,8,["references"])],64)):f("",!0),e.metadata?.annotations&&e.role==="assistant"&&!a(S)?(r(),l("div",je,[g("span",We,y(e.metadata?.annotations?.createdBy)+" "+y(a(s)("ai-agent.backend.configuration.editedAnswer")),1),d(D,{size:"xs",type:"dashed"})])):f("",!0)]),_:2},1032,["content"])):f("",!0)]),"after-tools":v(({message:e,index:p})=>[e.metadata?.suggestions&&a(u).length-1===p?(r(),l("div",Je,[(r(!0),l(F,null,L(e.metadata.suggestions,h=>(r(),l("div",{key:h},[d(i,{label:h,color:"primary",variant:"soft",onClick:Ze=>E(h)},null,8,["label","onClick"])]))),128))])):f("",!0)]),_:1},8,["messages","scroll-area-height","error","assistant"]))]),_:1})]),_:1},512),g("div",Ke,[g("div",Xe,[(r(!0),l(F,null,L(c.agent.quickCommands,e=>(r(),l("div",{key:e.name},[d(i,{color:"neutral",variant:"soft",onClick:p=>E(e.name)},{default:v(()=>[e.avatar?(r(),k(pe,{key:0,src:e.avatar,class:"h-4 w-4"},null,8,["src"])):f("",!0),g("span",null,y(e.name),1)]),_:2},1032,["onClick"])]))),128))]),d(ge,{modelValue:a(R),"onUpdate:modelValue":t[2]||(t[2]=e=>N(R)?R.value=e:null),"file-list":a(V),"onUpdate:fileList":t[3]||(t[3]=e=>N(V)?V.value=e:null),"is-loading":a(S),"model-config":c.agent.modelConfig,class:"sticky bottom-0 z-10 [view-transition-name:chat-prompt]",onStop:a(re),onSubmit:E},null,8,["modelValue","file-list","is-loading","model-config","onStop"])])])}}});export{Nt as default};

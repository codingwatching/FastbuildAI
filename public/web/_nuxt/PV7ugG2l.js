import{_ as de}from"./D6PQlFO0.js";import me from"./Dg6D3RQ3.js";import{d as W,e as J,s as V,ap as A,b as B,g as R,j as E,o as I,k as w,l as x,_ as H,n as k,q as b,v as G,p as a,A as P,x as pe,f as fe,a4 as ge,bA as K,bs as ve,ao as he,cx as xe,aR as Q,aJ as be,w as ye,i as _e,G as we,c as Fe,t as Ue,r as j,z as X,am as Le}from"#entry";import{_ as Y}from"./Bx0Ksjg_.js";import Te from"./BruVSCWF.js";import{_ as ze}from"./DfD19waA.js";import{_ as Se}from"./DLMDXBaB.js";import{u as ke}from"./C1DLXs69.js";import{j as Re}from"./B1XcE43x.js";import{_ as $e}from"./DlAUqK2U.js";const Ce={class:"text-background text-xs whitespace-pre-line"},Oe={class:"p-3"},Ie={class:"flex items-center gap-2"},je=["accept","disabled"],Ee=W({__name:"prompt-file-upload",props:{disabled:{type:Boolean},maxSize:{},accept:{}},emits:["file-select","url-submit"],setup(t,{emit:d}){const l=d,m=t,h=ke(),z=J("fileInputRefs"),r=V(""),p=V(!1),c=A(),{t:g}=B(),y=R(()=>{if(!h.selectedModel)return".pdf,.doc,.docx,.txt,.md";const n=h.selectedModel.features||[],s=[],f=[".pdf",".docx",".txt",".md",".rtf",".csv",".xlsx",".xls",".pptx"];return s.push(...f),n.includes("vision")&&s.push(".jpg",".jpeg",".png",".gif",".webp",".bmp"),n.includes("audio")&&s.push(".mp3",".wav",".flac",".aac",".ogg",".m4a"),s.join(",")}),$=R(()=>{const s=m.maxSize||100,f=h.selectedModel?.features?.includes("vision")||!1,U=g("common.chat.messages.uploadAttachmentTextOnly"),L=g("common.chat.messages.fileUploadLimit",{count:10,size:s}),C=f?g("common.chat.messages.supportsImage"):"";return`${U}
${L}${C}`}),_=()=>{p.value=!1,z.value?.click()};function F(n){const s=n.target,f=s.files?.[0];f&&l("file-select",f),s.value=""}function e(n){try{const U=new URL(n).pathname.split(".").pop()?.toLowerCase()||"";return U?`.${U}`:""}catch{const s=n.split(".").pop()?.toLowerCase()||"";return s?`.${s}`:""}}function o(n){return n?y.value.split(",").map(f=>f.trim()).includes(n.toLowerCase()):!1}function u(){const n=r.value.trim();if(!n)return;try{new URL(n)}catch{c.error(g("common.message.invalidUrl"));return}const s=e(n);if(!o(s)){c.error(g("common.message.unsupportedFileType"));return}l("url-submit",n),r.value="",p.value=!1}return(n,s)=>{const f=H,U=Y,L=Te,C=ze,T=Se;return I(),E(T,{open:a(p),"onUpdate:open":s[2]||(s[2]=S=>P(p)?p.value=S:null)},{content:w(()=>[b("div",Oe,[b("div",null,[x(L,{modelValue:a(r),"onUpdate:modelValue":s[1]||(s[1]=S=>P(r)?r.value=S:null),ui:{root:"w-full",trailing:"!pe-0 !pr-1"},placeholder:a(g)("common.chat.messages.inputUrlPlaceholder")},{trailing:w(()=>[x(f,{size:"xs",onClick:k(u,["stop"])},{default:w(()=>[pe(G(a(g)("common.confirm")),1)]),_:1})]),_:1},8,["modelValue","placeholder"])]),x(C,{class:"my-2",ui:{container:"text-xs font-normal text-muted-foreground"},label:"OR"}),b("div",Ie,[x(f,{size:"sm",label:a(g)("common.upload"),ui:{base:"flex-1 justify-center"},icon:"i-lucide-cloud-upload",variant:"outline",disabled:t.disabled,onClick:_},null,8,["label","disabled"])]),b("input",{ref_key:"fileInputRefs",ref:z,type:"file",accept:t.accept||a(y),class:"hidden",disabled:t.disabled,onChange:F},null,40,je)])]),default:w(()=>[x(U,{"delay-duration":0,ui:{content:"w-xs h-auto"}},{content:w(()=>[b("div",Ce,G(a($)),1)]),default:w(()=>[x(f,{onClick:s[0]||(s[0]=k(()=>{},["stop"])),size:"lg",variant:"ghost",icon:"i-lucide-paperclip",class:"rounded-full font-bold",disabled:t.disabled},null,8,["disabled"])]),_:1})]),_:1},8,["open"])}}}),Ve=["jpg","jpeg","png","gif","bmp","webp","svg"],Ne=["mp4","webm","ogg","mov","avi","wmv","flv","mkv"],Me=["mp3","wav","ogg","m4a","aac","flac","wma"],Pe=t=>t.extension?t.extension.toLowerCase():(t.name||t.originalName||"").split(".").pop()?.toLowerCase()||"",D=(t,d,l)=>{const m=Pe(t),h=t.type?.toLowerCase()||"";return d.includes(m)||h.startsWith(l)},Ae=t=>D(t,Ve,"image/"),Be=t=>D(t,Ne,"video/"),De=t=>D(t,Me,"audio/"),q=t=>Ae(t)?"image":Be(t)?"video":De(t)?"audio":"file";function Ge(){const{t}=B(),d=A(),l=fe([]),m=R(()=>l.value.some(e=>e.status==="uploading")),h=()=>`${Date.now()}-${Math.random().toString(36).slice(2,11)}`,z=e=>l.value.find(o=>o.id===e),r=(e,o)=>{const u=z(e);u&&Object.assign(u,o)},p=e=>{e.startsWith("blob:")&&URL.revokeObjectURL(e)},c=async e=>{const o=h(),u=URL.createObjectURL(e);l.value.push({id:o,name:e.name,size:e.size,url:u,progress:0,status:"uploading",mediaType:q(e),file:e});try{const n=await K({file:e,description:`Prompt file: ${e.name}`},{onProgress:s=>r(o,{progress:s})});return p(u),r(o,{status:"success",progress:100,url:n.url,result:n}),d.success(t("common.message.uploadSuccess")),n}catch(n){return console.error("File upload failed:",n),r(o,{status:"error",error:n instanceof Error?n.message:t("common.message.uploadFailed")}),d.error(t("common.message.uploadFailed")),null}},g=async e=>{try{new URL(e.trim())}catch{return d.error(t("common.message.invalidUrl")),!1}const o=`url-${h()}`,u=e.trim(),n=u.split("/").pop()||"Remote File";l.value.push({id:o,name:n,size:0,url:u,progress:0,status:"uploading",mediaType:"image"});try{const s=await ve({url:u,description:`Remote file: ${n}`});return r(o,{status:"success",progress:100,url:s.url,size:s.size,name:s.originalName,mediaType:q(s),result:s}),d.success(t("common.message.urlAdded")),!0}catch(s){return r(o,{status:"error",error:s instanceof Error?s.message:t("common.message.uploadFailed")}),d.error(t("common.message.uploadFailed")),!1}},y=e=>{const o=l.value.findIndex(u=>u.id===e.id);o!==-1&&(p(l.value[o]?.url??""),l.value.splice(o,1))},$=()=>{l.value.forEach(e=>p(e.url)),l.value=[]},_=async e=>{if(!e.file)return d.error(t("common.message.fileNotFound")),null;Object.assign(e,{status:"uploading",progress:0,error:void 0});try{const o=await K({file:e.file,description:`Prompt file: ${e.file.name}`},{onProgress:u=>e.progress=u});return p(e.url),Object.assign(e,{status:"success",progress:100,url:o.url,result:o}),d.success(t("common.message.uploadSuccess")),o}catch(o){return console.error("File upload failed:",o),Object.assign(e,{status:"error",error:o instanceof Error?o.message:t("common.message.uploadFailed")}),d.error(t("common.message.uploadFailed")),null}},F=()=>l.value.filter(e=>e.status==="success"&&e.result).map(e=>{switch(e.mediaType){case"image":return{type:"image_url",image_url:{url:e.url}};case"video":return{type:"video_url",video_url:{url:e.url}};case"audio":{const o=e.name.split(".").pop()?.toLowerCase()||"mp3";return{type:"input_audio",input_audio:{data:e.url,format:o}}}default:return{type:"file_url",name:e.name,url:e.url}}});return{files:ge(l),isUploading:m,uploadFile:c,addUrl:g,removeFile:y,clearFiles:$,retryUpload:_,generateFilesList:F}}const Ke={class:"flex items-center gap-2"},Qe={class:"flex items-end justify-between p-0 sm:p-2"},Xe={class:"flex items-center gap-2"},qe={class:"flex items-center gap-2"},We=W({__name:"chats-prompt",props:{modelValue:{default:""},fileList:{default:()=>[]},placeholder:{default:""},isLoading:{type:Boolean,default:!1},rows:{default:1},needAuth:{type:Boolean,default:!1},attachmentSizeLimit:{default:10}},emits:["update:modelValue","update:fileList","submit","stop"],setup(t,{emit:d}){const l=d,m=t,h=J("uTextareaRefs"),z=R(()=>h.value?.textareaRef||null),r=Q(m,"modelValue",l),p=Q(m,"fileList",l),{t:c}=B(),g=he(),y=A(),{focused:$}=xe(z,{initialValue:!1}),_=V(""),F=V(""),e=R(()=>F.value!==""&&r.value.trim()===F.value.trim()),{files:o,isUploading:u,uploadFile:n,addUrl:s,removeFile:f,retryUpload:U,generateFilesList:L,clearFiles:C}=Ge(),T=R(()=>r.value.trim().length>0||o.value.length>0);function S(){h.value?.textareaRef?.focus(),!g.isAgreed&&m.needAuth&&Le("/login")}function Z(i){if(!i.isComposing&&i.key==="Enter"&&!i.shiftKey){if(i.preventDefault(),!T.value)return;m.isLoading?l("stop"):l("submit",r.value)}}function ee(){if(m.isLoading)l("stop");else{if(!T.value)return;l("submit",r.value)}}async function te(i){await n(i)&&(p.value=L())}async function se(i){await s(i)&&(p.value=L())}function oe(i){"id"in i&&(f(i),p.value=L())}async function ae(i){"id"in i&&await U(i)&&(p.value=L())}const{lockFn:ne,isLock:O}=be(async()=>{if(!r.value.trim()){y.warning(c("common.chat.messages.enterQuestion"));return}if(!m.isLoading)try{_.value=r.value.trim();const i=localStorage.getItem("modelId")||void 0,v=await Re({modelId:i,text:_.value});v.optimizedText?(F.value=v.optimizedText,r.value=v.optimizedText,y.success(c("common.chat.messages.optimizeSuccess"))):y.warning(c("common.chat.messages.optimizeEmpty"))}catch(i){console.error("文案优化失败:",i);const v=i?.message||c("common.chat.messages.optimizeFailed");y.error(v)}});function ie(){_.value&&(r.value=_.value,F.value="",_.value="")}return ye(()=>m.fileList,i=>{i.length===0&&o.value.length>0&&C()}),_e(()=>we(()=>{g.isAgreed&&S()})),(i,v)=>{const re=de,le=me,N=H,M=Y,ce=Ee;return I(),Fe("div",{class:X(["chat-action-bar w-full rounded-md border p-1.5 transition-[border-color_box-shadow] duration-200 sm:rounded-2xl",a($)?"ring-primary/15 border-primary ring-3":"border-border"]),onClick:k(S,["stop"])},[b("div",Ke,[j(i.$slots,"panel-top",{},void 0,!0)]),a(o).length>0?(I(),E(re,{key:0,files:[...a(o)],"show-actions":!0,class:"p-1.5",onRemove:oe,onRetry:ae},null,8,["files"])):Ue("",!0),x(le,{ref_key:"uTextareaRefs",ref:h,modelValue:a(r),"onUpdate:modelValue":v[0]||(v[0]=ue=>P(r)?r.value=ue:null),class:X(["custom-textarea-wrapper w-full",{"optimizing-text":a(O)}]),style:{"--ui-bg-elevated":"var(--color-background)"},variant:"ghost",rows:t.rows,maxrows:8,highlight:!1,autoresize:!0,ui:{base:"resize-none custom-textarea text-base min-h-[40px] focus:bg-transparent hover:bg-transparent"},placeholder:t.placeholder||a(c)("common.chat.messages.inputPlaceholder"),disabled:a(O),onKeydown:Z},null,8,["modelValue","class","rows","placeholder","disabled"]),b("div",Qe,[b("div",Xe,[j(i.$slots,"panel-left",{},()=>[v[1]||(v[1]=b("div",null,null,-1))],!0)]),j(i.$slots,"panel-right",{},()=>[b("div",qe,[a(e)?(I(),E(M,{key:0,text:a(c)("common.chat.messages.revertText"),"delay-duration":0,arrow:!0},{default:w(()=>[x(N,{icon:"i-lucide-undo-2",class:"rounded-full font-bold",size:"lg",variant:"ghost",color:"primary",disabled:m.isLoading,onClick:k(ie,["stop"])},null,8,["disabled"])]),_:1},8,["text"])):(I(),E(M,{key:1,text:a(O)?a(c)("common.chat.messages.optimizing"):a(r)?.trim()?a(c)("common.chat.messages.optimizeText"):a(c)("common.chat.messages.enterQuestion"),"delay-duration":0,arrow:!0},{default:w(()=>[x(N,{icon:"i-lucide-sparkles",class:"rounded-full font-bold",size:"lg",variant:"ghost",color:"primary",disabled:a(O)||!a(r)?.trim()||m.isLoading,loading:a(O),onClick:k(a(ne),["stop"])},null,8,["disabled","loading","onClick"])]),_:1},8,["text"])),x(ce,{disabled:a(u),maxSize:t.attachmentSizeLimit,onFileSelect:te,onUrlSubmit:se},null,8,["disabled","maxSize"]),j(i.$slots,"panel-right-item",{},void 0,!0),x(M,{content:{align:"center",side:"top",sideOffset:8},text:t.isLoading?a(c)("common.chat.messages.stopGeneration"):a(T)?a(c)("common.chat.messages.sendMessage"):a(c)("common.chat.messages.enterQuestion"),"delay-duration":0,arrow:!0,disabled:t.isLoading||a(T)},{default:w(()=>[x(N,{icon:t.isLoading?"i-lucide-square":"i-lucide-arrow-up",class:"rounded-full font-bold",size:"lg",disabled:!t.isLoading&&!a(T),color:t.isLoading?"error":"primary",onClick:k(ee,["stop"])},null,8,["icon","disabled","color"])]),_:1},8,["text","disabled"])])],!0)])],2)}}}),Je=$e(We,[["__scopeId","data-v-d0469a7d"]]),rt=Object.freeze(Object.defineProperty({__proto__:null,default:Je},Symbol.toStringTag,{value:"Module"}));export{Je as _,De as a,rt as c,q as g,Be as i};

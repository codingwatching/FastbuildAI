const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DH0fxYWa.js","./C4ofdRUp.js","./4jjeIyfe.js","./D_3bTjYR.js","./D9sX2Qi6.js","./C4S285vI.js","./BTN3Ax-V.js","./BKdtdX-7.js","./CtosDvS0.js","./kRIii9yh.js","./DxD6Ynfo.js","./BhB8DUPm.js","./C6Y-ieo6.js","./zlMhJk0P.js","./DeCyaT7k.js","./D4e4FYoF.js","./BCcN9pii.js","./CMKSl-Ng.js","./CuVAPZQ8.js","./psimjGaX.js","./B3rWqoNg.js","./EK7Wbu3-.js","./BjKIBNOf.js","./DWy_CFG9.js","./td2xDKru.js","./BMSQkwth.js","./DaWZu8wl.js","./bvMLy1sv.js","./CAQVAH0V.js","./Deu6qIfg.js","./BtLy_Oaq.js","./D19QCKnC.js","./LSmoYDCw.js","./B3XNqw4u.js","./BVraOlsu.js","./BxwUS5gW.js","./MCK2d4XT.js","./meHCBXcx.js","./D2M85Dwf.js","./FTderXKt.js","./DpytHuLS.js","./BkF8DltG.js","./jsPNKUA0.js","./Bzv9SrOl.js","./DvNezYYM.js","./cd55qm53.js","./CBP5wIdr.js","./BstbYvQo.js"])))=>i.map(i=>d[i]);
import{d as Ee,i as Ue,at as Le,bu as Be,s as D,a_ as nt,q as De,J as ce,p as W,b2 as te,b3 as ae,n as R,aW as ot,f as $,o as n,bb as lt,w as f,x as a,t as u,c as m,y,T as it,g as e,G as rt,z as _,_ as Re,B as je,A as Ne,F as z,E,v as Se,C as se,D as ue,l as ct,aX as ut,h as xe,aO as be,aM as dt,j as Fe,V as mt,k as ft,aR as pt,R as re,a2 as vt,bJ as ze,ai as gt,a$ as ht,H as _t,W as ye,I as xt,aZ as yt,X as ke}from"#entry";import{_ as kt}from"./DQHBghLR.js";import{_ as bt,a as wt}from"./DBvEIrVk.js";import{_ as Ct}from"./shdu-Ndv.js";import{_ as $t}from"./Dl_TiQPG.js";import{_ as qe}from"./BkF8DltG.js";import{_ as Tt}from"./DWe_-2t3.js";import{g as St,h as Ft,i as zt,j as Vt,k as Ve,l as It,m as At}from"./D2M85Dwf.js";import{e as Mt}from"./C457VaE0.js";import{e as Ie}from"./Bni8bPEl.js";import Et from"./cd55qm53.js";import{_ as Ut}from"./D_3bTjYR.js";import{_ as Lt}from"./BTN3Ax-V.js";import{_ as Bt}from"./CWpJD8K1.js";import{_ as Dt}from"./l1ozQanh.js";import{g as Rt}from"./eeyg4-1U.js";import{u as Ae}from"./oxig-ZyS.js";import{d as jt}from"./MCK2d4XT.js";import{_ as Nt}from"./Bzv9SrOl.js";import{u as Me}from"./Brot9FFj.js";import{u as qt}from"./CKZGjRTU.js";const Ot={class:"relative h-full flex-1"},Pt={key:0,class:"flex h-full min-h-0 w-[240px] flex-col"},Gt={class:"border-border/50 border-b p-4"},Ht={class:"flex items-center gap-3"},Qt={class:"min-w-0 flex-1"},Kt={class:"truncate font-medium"},Jt={class:"h-full flex-1 overflow-hidden"},Wt={key:0,class:"text-muted-foreground flex h-full flex-col items-center justify-center text-center text-sm"},Xt={class:"mb-2"},Yt={class:"flex flex-col gap-4 space-y-1 py-4 pr-4 pl-2"},Zt={class:"text-muted-foreground px-2 py-1 text-xs font-medium"},ea={class:"flex flex-col gap-1"},ta={class:"block flex-1 truncate text-left"},aa={key:0,class:"flex flex-col gap-4 py-4"},sa={class:"px-2 py-1"},na={class:"flex flex-col gap-1"},oa={class:"border-border/50 border-t pt-2"},la={class:"text-muted-foreground flex items-center justify-center gap-1 text-xs"},ia=["href"],ra={key:0,class:"absolute top-4 left-4 z-50 flex items-center gap-2"},ca={class:"group relative"},ua={class:"block flex-1 truncate text-left text-sm"},da={key:0,class:"text-muted-foreground flex h-full w-50 flex-col items-center justify-center text-center text-sm"},ma={class:"mb-2"},fa={class:"flex flex-col gap-4 space-y-1 py-4 pr-4 pl-2"},pa={class:"text-muted-foreground px-2 py-1 text-xs font-medium"},va={class:"flex flex-col gap-1"},ga={class:"block flex-1 truncate text-left"},ha={key:0,class:"flex flex-col gap-4 py-4"},_a={class:"px-2 py-1"},xa={class:"flex flex-col gap-1"},ya=Ee({inheritAttrs:!1,__name:"chats-list",props:{agent:{},publishToken:{},accessToken:{},modelValue:{}},emits:["update:modelValue","new-conversation","switch-conversation"],async setup(b,{emit:x}){let T,X;const g=b,j=x,de=Et,C=Ut,{t:Y}=Ue(),ne=Le(),h=ot(g,"modelValue",j),G=Be("(max-width: 768px)"),w=D(!1),S=D(!1),L=nt();De(()=>{ce(()=>{G.value||(w.value=!0)})}),W(G,c=>{c?w.value=!1:(S.value=!1,w.value=!0)},{immediate:!1});const{data:me,pending:N}=([T,X]=te(()=>ae(()=>`public-agent-conversations-${g.publishToken}-${g.accessToken}`,()=>g.accessToken?St(g.publishToken,g.accessToken,{page:1,pageSize:50}):{items:[]},{watch:[()=>g.accessToken]})),T=await T,X(),T),v=R(()=>me.value?.items||[]),U=R(()=>v.value?.length?Rt(v.value,"updatedAt",Y):[]);W(v,c=>{c?.length>0&&((g.modelValue?c.some(A=>A.id===g.modelValue):!1)?g.modelValue||j("switch-conversation",c[0]):(h.value=null,j("switch-conversation",c[0])))},{immediate:!0});const K=c=>{S.value=!1,j("switch-conversation",c)},q=()=>{j("new-conversation")},Z=()=>{G.value?(S.value=!0,w.value=!1):(S.value=!1,w.value=!0)},F=async c=>{const l=ct(c.title);try{const A=ut({setup(){return()=>xe("div",{class:"py-2"},[xe(C,{label:"对话标题",size:"lg",required:!0,error:l.value.trim()?"":"对话标题不能为空"},{default:()=>xe(de,{modelValue:l.value,"onUpdate:modelValue":V=>{l.value=V},placeholder:"请输入对话标题",maxlength:50,class:"w-full"})})])}});await Ae({title:"编辑对话标题",content:A,confirmText:"保存",cancelText:"取消",color:"primary",ui:{content:"!w-sm"}}),l.value.trim()&&l.value!==c.title&&await I(c.id,l.value)}catch(A){console.log("用户取消编辑操作:",A)}},I=async(c,l)=>{try{await Ft(g.publishToken,g.accessToken,c,{title:l}),await be(`public-agent-conversations-${g.publishToken}-${g.accessToken}`),ne.success("对话标题更新成功")}catch(A){console.error("更新对话标题失败:",A)}},O=async c=>{if(g.accessToken)try{await zt(g.publishToken,g.accessToken,c.id),await be(`public-agent-conversations-${g.publishToken}-${g.accessToken}`),g.modelValue===c.id&&(h.value=null,j("new-conversation")),ne.success(Y("common.message.deleteSuccess"))}catch(l){console.error("删除对话失败:",l)}},oe=async c=>{try{await Ae({color:"error",title:"确认删除",content:"确定要删除这个会话吗？删除后无法恢复。",confirmText:"删除",cancelText:"取消",ui:{content:"!w-sm"}})&&await O(c)}catch(l){console.log("用户取消删除操作:",l)}},fe=c=>[{label:"编辑",color:"primary",icon:"i-lucide-pencil",onSelect:()=>F(c)},{label:"删除",color:"error",icon:"i-lucide-trash",onSelect:()=>oe(c)}];return jt({o:()=>S.value=!S.value}),(c,l)=>{const A=rt,V=je,B=Re,s=Lt,J=Bt,le=qe,pe=Dt,ve=lt;return n(),$(ve,null,{default:f(()=>[a("div",Ot,[u(it,{name:"sidebar"},{default:f(()=>[e(w)?(n(),m("div",Pt,[a("div",Gt,[a("div",Ht,[u(A,{src:b.agent?.avatar,alt:b.agent?.name,size:"sm"},null,8,["src","alt"]),a("div",Qt,[a("h2",Kt,_(b.agent?.name),1)]),u(B,{color:"neutral",variant:"ghost",size:"sm",class:"p-2",onClick:l[0]||(l[0]=i=>w.value=!1)},{default:f(()=>[u(V,{name:"i-lucide-panel-left",class:"size-5"})]),_:1})]),u(B,{class:"mt-3 w-full",color:"primary",variant:"soft",onClick:q},{default:f(()=>[u(V,{name:"i-lucide-plus",class:"mr-2 size-4"}),l[4]||(l[4]=Ne(" 新建会话 ",-1))]),_:1})]),a("div",Jt,[!e(U).length&&!e(N)?(n(),m("div",Wt,[a("div",Xt,[u(V,{name:"i-lucide-message-circle",size:"lg",class:"text-muted-foreground"})]),l[5]||(l[5]=a("p",null,"暂无会话记录",-1)),l[6]||(l[6]=a("p",{class:"text-xs"},"开始与智能体对话吧",-1))])):(n(),$(le,{key:1,class:"grid h-full"},{default:f(()=>[a("div",Yt,[(n(!0),m(z,null,E(e(U),i=>(n(),m("div",{key:i.key,class:"flex flex-col gap-2"},[a("div",Zt,_(i.label),1),a("div",ea,[(n(!0),m(z,null,E(i.items,p=>(n(),m("div",{key:p.id,class:"group relative"},[u(B,{label:p.title,ui:{base:"flex justify-between w-full gap-2 cursor-pointer pr-10 relative w-full"},variant:p.id===b.modelValue?"soft":"ghost",color:p.id===b.modelValue?"primary":"neutral",onClick:ee=>K(p)},{default:f(()=>[a("span",ta,_(p.title||"新会话"),1)]),_:2},1032,["label","variant","color","onClick"]),u(s,{items:[fe(p)],ui:{content:"w-3",group:"flex flex-col gap-1 p-2",itemLeadingIcon:"size-4"},content:{side:"right",align:"start"}},{default:f(()=>[u(V,{name:"i-lucide-ellipsis",size:14,class:se(["absolute top-1/2 right-3 z-10 h-8 -translate-y-1/2 cursor-pointer px-2.5 py-1.5 opacity-0 transition-opacity group-hover:opacity-100",{"opacity-100":p.id===b.modelValue}]),onClick:l[1]||(l[1]=Se(()=>{},["stop"]))},null,8,["class"])]),_:2},1032,["items"])]))),128))])]))),128)),!e(U).length&&e(N)?(n(),m("div",aa,[(n(),m(z,null,E(3,i=>a("div",{key:`group-${i}`,class:"flex flex-col gap-2"},[a("div",sa,[u(J,{class:"h-4 w-16"})]),a("div",na,[(n(!0),m(z,null,E(i===1?3:i===2?2:1,p=>(n(),$(J,{key:`item-${i}-${p}`,class:"h-10 w-full rounded-md"}))),128))])])),64))])):y("",!0)])]),_:1}))]),a("div",oa,[a("div",la,[a("span",null,_(e(L).siteConfig?.copyright.copyrightText),1),a("a",{class:"text-primary font-bold",href:e(L).siteConfig?.copyright.copyrightUrl,target:"_blank"},_(e(L).siteConfig?.copyright.copyrightBrand),9,ia)])])])):y("",!0)]),_:1}),e(w)?y("",!0):(n(),m("div",ra,[u(B,{color:"neutral",variant:"soft",size:"lg",class:"p-2",onClick:Z},{default:f(()=>[u(V,{name:"i-lucide-panel-right",class:"size-5"})]),_:1}),l[8]||(l[8]=a("div",{class:"text-muted-foreground mx-1"},"/",-1)),a("div",ca,[b.modelValue?(n(),$(s,{key:1,items:[{label:"删除",color:"error",icon:"i-lucide-trash",onSelect:()=>oe(e(v).find(i=>i.id===b.modelValue))},{label:"新建对话",color:"primary",icon:"i-lucide-plus",onSelect:()=>q()}],ui:{content:"w-32",group:"flex flex-col gap-1 p-2",itemLeadingIcon:"size-4"},content:{side:"bottom",align:"center"}},{default:f(()=>[u(B,{label:e(v).find(i=>i.id===b.modelValue)?.title||"当前对话",variant:"ghost",color:"neutral",size:"sm",class:"px-3 py-2"},{default:f(()=>[a("span",ua,_(e(v).find(i=>i.id===b.modelValue)?.title||"当前对话"),1),u(V,{name:"i-lucide-chevron-down",class:"size-5"})]),_:1},8,["label"])]),_:1},8,["items"])):(n(),$(B,{key:0,variant:"ghost",color:"neutral",size:"sm",class:"px-3 py-2"},{default:f(()=>[...l[7]||(l[7]=[a("span",{class:"block flex-1 truncate text-left text-sm"},"New Chat",-1)])]),_:1}))])])),u(pe,{open:e(S),"onUpdate:open":l[3]||(l[3]=i=>ue(S)?S.value=i:null),side:"left",ui:{content:"!w-fit flex-0 max-w-fit"}},{content:f(()=>[!e(U).length&&!e(N)?(n(),m("div",da,[a("div",ma,[u(V,{name:"i-lucide-message-circle",size:"lg",class:"text-gray-400"})]),l[9]||(l[9]=a("p",null,"暂无会话记录",-1)),l[10]||(l[10]=a("p",{class:"text-xs"},"开始与智能体对话吧",-1))])):(n(),$(le,{key:1,class:"h-full"},{default:f(()=>[a("div",fa,[(n(!0),m(z,null,E(e(U),i=>(n(),m("div",{key:i.key,class:"flex flex-col gap-2"},[a("div",pa,_(i.label),1),a("div",va,[(n(!0),m(z,null,E(i.items,p=>(n(),m("div",{key:p.id,class:"group relative"},[u(B,{label:p.title,ui:{base:"flex justify-between w-full gap-2 cursor-pointer pr-10 relative w-full"},variant:p.id===b.modelValue?"soft":"ghost",color:p.id===b.modelValue?"primary":"neutral",onClick:ee=>K(p)},{default:f(()=>[a("span",ga,_(p.title||"新会话"),1)]),_:2},1032,["label","variant","color","onClick"]),u(s,{items:[fe(p)],ui:{content:"w-3",group:"flex flex-col gap-1 p-2",itemLeadingIcon:"size-4"},content:{side:"right",align:"start"}},{default:f(()=>[u(V,{name:"i-lucide-ellipsis",size:14,class:se(["absolute top-1/2 right-3 z-10 h-8 -translate-y-1/2 cursor-pointer px-2.5 py-1.5 opacity-0 transition-opacity group-hover:opacity-100",{"opacity-100":p.id===b.modelValue}]),onClick:l[2]||(l[2]=Se(()=>{},["stop"]))},null,8,["class"])]),_:2},1032,["items"])]))),128))])]))),128)),!e(U).length&&e(N)?(n(),m("div",ha,[(n(),m(z,null,E(3,i=>a("div",{key:`group-${i}`,class:"flex flex-col gap-2"},[a("div",_a,[u(J,{class:"h-4 w-16"})]),a("div",xa,[(n(!0),m(z,null,E(i===1?3:i===2?2:1,p=>(n(),$(J,{key:`item-${i}-${p}`,class:"h-10 w-full rounded-md"}))),128))])])),64))])):y("",!0)])]),_:1}))]),_:1},8,["open"])])]),_:1})}}}),ka=Nt(ya,[["__scopeId","data-v-0e845e1e"]]),ba={class:"bg-secondary h-full flex-none"},wa={key:0,class:"flex h-full w-full items-center justify-center"},Ca={class:"flex items-center gap-3"},$a={class:"text-lg"},Ta={key:1,class:"flex h-full w-full items-center justify-center"},Sa={class:"text-center"},Fa={class:"mb-2 text-xl font-semibold"},za={class:"text-muted-foreground"},Va={class:"text-muted-foreground text-sm"},Ia={key:0,class:"flex items-center gap-2"},Aa={class:"my-2 flex items-center gap-1"},Ma={class:"text-muted-foreground flex-none text-xs"},Ea={key:0,class:"m-2 space-y-2"},Ua={key:2,class:"bg-background shadow-default my-6 w-full rounded-2xl"},La={class:"text-foreground border-muted/10 text-md flex items-center justify-between border-b p-4 font-medium"},Ba={class:"flex items-center gap-2"},Da={key:0,class:"mt-2 p-4"},Ra={class:"w-full max-w-[800px] p-4 lg:py-2"},ja={key:0,class:"mb-3"},Na={class:"flex flex-wrap gap-2"},qa={key:0,class:"text-muted-foreground text-xs"},ds=Ee({__name:"chat",props:{billingMode:{}},async setup(b){let x,T;const X=ye(()=>ke(()=>import("./DH0fxYWa.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39]),import.meta.url)),g=ye(()=>ke(()=>import("./DpytHuLS.js"),__vite__mapDeps([40,41,1,42,43,31,32,33,13,18,11,34,35,36,21]),import.meta.url)),j=ye(()=>ke(()=>import("./DvNezYYM.js"),__vite__mapDeps([44,45,1,3,4,2,46,8,28,10,13,14,15,11,47,18,30,39,26]),import.meta.url)),de=b,{t:C}=Ue(),Y=Be("(max-width: 768px)"),{params:ne}=dt(),h=R(()=>ne.id||""),G=Fe(),w=Le(),S=mt(),L=ft("scrollAreaRef"),{height:me}=pt(L),N=re(`public_agent_conversation_${h.value}`),v=D(G.isLogin&&N.value||null),U=D(!0),K=D(""),q=D(null),Z=D({question:"",answer:"",enabled:!0}),F=D(!1);W(v,t=>{G.isLogin?N.value=t:N.value=null});const I=vt({page:1,pageSize:15}),O=D(!1),{data:oe,refresh:fe}=([x,T]=te(async()=>ae(`access-token-${h.value}`,async()=>{const t=`public_agent_token_${h.value}`,o=re(t);if(o.value)return{accessToken:o.value,fromCache:!0};try{const d=await Vt(h.value);return o.value=d.accessToken,{...d,fromCache:!1}}catch(d){throw console.error("生成访问令牌失败:",d),d}})),x=await x,T(),x),c=R(()=>oe.value?.accessToken||""),{data:l,refresh:A}=([x,T]=te(()=>ae(()=>!v.value||!c.value?(console.log("conversationId.value",v.value),{items:[],total:0,page:I.page,pageSize:I.pageSize}):Ve(h.value,c.value,v.value,I),{transform:t=>t},"$zgx5FY2pBK")),x=await x,T(),x),{data:V}=([x,T]=te(()=>ae("chat-config",()=>Mt())),x=await x,T(),x);l.value||(K.value="智能体不存在或未发布"),l.value?.items?.length||(v.value=null),O.value=l.value?.total>(l.value?.items?.length||0);const B=R(()=>l.value?.items?l.value.items.map(t=>({...t,id:t.id||Me(),avatar:s.value?.chatAvatar||s.value?.avatar,status:"completed"})):[]),{data:s,pending:J}=([x,T]=te(()=>ae(`public-agent-${h.value}`,()=>It(h.value,c.value))),x=await x,T(),x),le=()=>{v.value=null,I.page=1,i.value=[],F.value=!0,s.value&&(s.value.formFieldsInputs={})},pe=async t=>{t.id!==v.value&&(v.value=t.id,I.page=1,A(),H())},ve=t=>{if(!s.value)return;const o=t.slice().reverse().find(d=>d?.role==="user"&&d.formFieldsInputs);console.log("lastUserMessage",o),s.value.formFieldsInputs=o?.formFieldsInputs||{}},{messages:i,input:p,files:ee,handleSubmit:Oe,reload:Pe,stop:we,status:Ge,error:He}=qt({api:At,initialMessages:[],chatConfig:{get avatar(){return s.value?.chatAvatar||s.value?.avatar}},body:{publishToken:h.value,accessToken:c.value,saveConversation:!0,get conversationId(){return v.value},get billingMode(){return de.billingMode},get formFields(){return s.value?.formFields||[]},get formFieldsInputs(){return s.value?.formFieldsInputs||{}}},onToolCall(){},onResponse(t){t.status===401&&Fe().logout(!0)},onUpdate(t){t.type==="conversation_id"&&(v.value=t.data,be(`public-agent-conversations-${h.value}-${c.value}`))},onError(t){console.error("聊天错误:",t?.message||"发送失败")},onFinish(t){console.log("聊天完成:",t)}}),ge=R(()=>Ge.value==="loading");W(()=>G.isLogin,t=>{t||(re(`public_agent_conversation_${h.value}`,{maxAge:-1,path:"/"}).value=null,re(`public_agent_token_${h.value}`,{maxAge:-1,path:"/"}).value=null,we(),i.value=[],v.value=null,O.value=!1,I.page=1,F.value=!0)},{immediate:!0});const Qe=async()=>{if(!(!O.value||!v.value||!h.value||!c.value)){I.page++;try{const t=await Ve(h.value,c.value,v.value,I),o=t.items?.reverse().map(d=>({id:d.id||Me(),role:d.role,content:d.content,status:"completed",mcpToolCalls:d.mcpToolCalls}))||[];i.value.unshift(...o),O.value=t.total>i.value.length}catch(t){I.page--,console.error("加载更多消息失败:",t),O.value=!0}}},he=ze(t=>{const o=t.target,d=40;U.value=o.scrollHeight-(o.scrollTop+o.clientHeight)<=d},100),H=async(t=!0)=>{await ce(),L.value?.scrollToBottom(t)},Ce=()=>{if(!s.value)return w.error("智能体信息未加载"),!1;const t=s.value.formFields||[],o=s.value.formFieldsInputs||{};if(t.length===0)return!0;const d=[];return t.forEach(k=>{if(k.required){const M=o[k.name];(!M||typeof M=="string"&&M.trim()==="")&&d.push(`${k.label}是必填字段`)}}),d.length>0?(w.error(`表单验证失败: ${d.join(", ")}`),!1):!0},Ke=()=>{Ce()&&(F.value=!1)},ie=async t=>{if(!(!t.trim()||ge.value)){if(!s.value)return w.error("智能体信息未加载");if(!c.value)return w.error("请先生成访问令牌");Ce()&&(await Oe(t),H())}};W(B,t=>{t&&(i.value=[...t],ve(t),ce(()=>{t.length>0?H(!1):F.value=!0}))},{immediate:!0}),W(()=>i.value.at(-1)?.content,()=>{ce(()=>{U.value&&H(!1)})},{flush:"post"});const Je=t=>{S.create(g).open({context:t})},We=(t,o=null)=>{q.value=o,S.create(X).open({agentId:s.value?.id,hiddenStatus:!0,annotationId:t,messageId:o,isPublic:!0,publishToken:h.value,accessToken:c.value,initialData:void 0,onResult:k=>{$e(!0,k)}})},Xe=(t,o)=>{const d=i.value[o-1];if(!d||d.role!=="user"){w.error("找不到对应的用户问题");return}Z.value={question:Ie(d.content),answer:Ie(t.content),enabled:!0},q.value=t.id||null,S.create(X).open({agentId:s.value?.id,annotationId:null,messageId:t.id||null,isPublic:!0,publishToken:h.value,accessToken:c.value,initialData:Z.value,onResult:M=>{$e(!0,M)}})};function $e(t,o){if(o?.id&&q.value){const d=i.value.findIndex(k=>k.id===q.value);if(d>=0){const k=i.value[d];k&&!k.metadata&&(k.metadata={}),k?.metadata&&(k.metadata.annotations={annotationId:o.id,createdBy:"",question:"",similarity:1})}}q.value=null,Z.value={question:"",answer:"",enabled:!0}}let _e=null;return De(async()=>{H(!1);const t=L.value?.getViewportElement(),o=t&&t.viewportElement;if(o){o.addEventListener("scroll",he,{passive:!0}),he({target:o});const d=ze(()=>{U.value&&H(!1)},50);_e=new MutationObserver(()=>{d()}),_e.observe(o,{childList:!0,subtree:!1,characterData:!1})}}),gt(()=>{const t=L.value?.getViewportElement();(t&&t.viewportElement)?.removeEventListener("scroll",he),_e?.disconnect()}),ht({title:R(()=>s.value?`${s.value.name} - BuildingAI`:"BuildingAI"),link:[{rel:"icon",href:R(()=>s.value?.avatar||"/favicon.ico")},{rel:"apple-touch-icon",href:R(()=>s.value?.avatar||"/favicon.ico")}]}),(t,o)=>{const d=je,k=kt,M=Re,Te=wt,Ye=Ct,Ze=$t,et=bt,tt=qe,at=yt,st=Tt;return n(),m("div",{class:se(["ai-chat bg-secondary flex h-full min-h-0 items-center justify-center rounded-l-xl p-2",{"p-0!":e(Y)}])},[a("div",ba,[u(ka,{agent:e(s),"publish-token":e(h),"access-token":e(c),modelValue:e(v),"onUpdate:modelValue":o[0]||(o[0]=r=>ue(v)?v.value=r:null),onNewConversation:le,onSwitchConversation:pe},null,8,["agent","publish-token","access-token","modelValue"])]),a("div",{class:se(["bg-background flex h-full min-h-0 w-full flex-col items-center rounded-xl",{"rounded-none!":e(Y)}])},[e(J)?(n(),m("div",wa,[a("div",Ca,[u(d,{name:"i-lucide-loader-2",class:"text-primary size-6 animate-spin"}),a("span",$a,_(t.$t("ai-agent.frontend.chat.loadingAgent")),1)])])):e(K)?(n(),m("div",Ta,[a("div",Sa,[u(d,{name:"i-lucide-alert-circle",class:"text-error mx-auto mb-4 size-12"}),a("h2",Fa,_(t.$t("ai-agent.frontend.chat.loadingFailed")),1),a("p",za,_(e(K)),1)])])):e(s)?(n(),m(z,{key:2},[o[6]||(o[6]=a("div",{class:"flex h-12 w-full items-center justify-center"},null,-1)),u(tt,{class:"h-full min-h-0 w-full",type:"auto",ref_key:"scrollAreaRef",ref:L,onInView:o[3]||(o[3]=r=>H(!1))},{default:f(()=>[u(et,{loading:!1,"has-more":e(O),threshold:500,"content-class":"max-w-[800px] w-full space-y-3 p-4 lg:py-4",onLoadMore:Qe},{default:f(()=>[e(i).length===0&&(!e(F)||!e(s).formFields?.length)&&e(s).openingStatement?.length&&e(s).openingQuestions?.length?(n(),$(Te,{key:0,messages:[{role:"assistant",avatar:e(s)?.chatAvatar||e(s)?.avatar,content:e(s)?.openingStatement||""}],"scroll-area-height":200,assistant:{actions:[]}},{content:f(({message:r})=>[u(k,{content:r.content.toString(),"show-run-button":!1},null,8,["content"]),a("div",{class:se(["flex flex-col gap-2",{"ml-4":e(s)?.avatar}])},[a("div",Va,_(t.$t("ai-agent.frontend.chat.youCanAskMe")),1),(n(!0),m(z,null,E(e(s)?.openingQuestions||[],P=>(n(),m("div",{key:P},[u(M,{label:P,color:"primary",variant:"soft",onClick:Q=>ie(P)},null,8,["label","onClick"])]))),128))],2)]),_:1},8,["messages"])):y("",!0),e(i).length!==0?(n(),$(Te,{key:1,messages:e(i),"scroll-area-height":e(me),error:e(He),assistant:{actions:[{label:e(C)("ai-chat.frontend.messages.retry"),icon:"i-lucide-rotate-cw-square",onClick:()=>e(Pe)()},{label:e(C)("ai-agent.frontend.chat.chatContext"),icon:"i-lucide-file-type",show:!e(s).showContext,onClick:r=>{r?.metadata?.context?Je(r.metadata.context):e(w).error(e(C)("ai-agent.backend.configuration.noChatContext"))}},{label:e(C)("ai-agent.frontend.chat.annotation"),icon:"i-lucide-wrap-text",show:!e(s).enableFeedback,onClick:(r,P)=>{const Q=r.metadata?.annotations?.annotationId;Q?We(Q,r.id):Xe(r,P)}}]},"spacing-offset":160},{content:f(({message:r})=>[r.content.length?(n(),$(k,{key:0,content:r.content.toString(),"show-run-button":!1},{before:f(()=>[r.status==="loading"?(n(),m("div",Ia,[u(d,{name:"i-lucide-loader-2",class:"animate-spin"}),a("span",null,_(e(C)("ai-chat.frontend.messages.thinking")),1)])):y("",!0)]),after:f(()=>[r.metadata?.references&&r.metadata.references.length>0&&r.role==="assistant"&&!e(ge)&&e(s).showReference?(n(),m(z,{key:0},[a("div",Aa,[a("span",Ma,_(e(C)("ai-agent.frontend.chat.reference")),1),r.metadata?.references&&r.metadata.references.length>0&&r.role==="assistant"?(n(),$(Ye,{key:0,size:"xs",type:"dashed"})):y("",!0)]),u(Ze,{references:r.metadata.references},null,8,["references"])],64)):y("",!0)]),_:2},1032,["content"])):y("",!0)]),"after-tools":f(({message:r,index:P})=>[r.metadata?.suggestions&&e(i).length-1===P?(n(),m("div",Ea,[(n(!0),m(z,null,E(r.metadata.suggestions,Q=>(n(),m("div",{key:Q},[u(M,{label:Q,color:"primary",variant:"soft",onClick:Oa=>ie(Q)},null,8,["label","onClick"])]))),128))])):y("",!0)]),_:1},8,["messages","scroll-area-height","error","assistant"])):y("",!0),e(s).formFields&&e(s).formFields.length>0?(n(),m("div",Ua,[a("div",La,[a("span",Ba,[u(d,{name:"i-lucide-bot-message-square",class:"text-primary size-7"}),Ne(" "+_(e(C)("ai-agent.frontend.chat.newConversationSettings")),1)]),e(i).length||!e(F)?(n(),$(M,{key:0,color:"primary",variant:"ghost",size:"sm",onClick:o[1]||(o[1]=r=>F.value=!e(F))},{default:f(()=>[a("span",null,_(e(F)?e(C)("console-common.close"):e(C)("console-common.edit")),1)]),_:1})):y("",!0)]),_t(a("div",null,[u(e(j),{inputs:e(s).formFieldsInputs,"onUpdate:inputs":o[2]||(o[2]=r=>e(s).formFieldsInputs=r),formFields:e(s).formFields,class:"w-full bg-transparent pt-0",formClass:"bg-muted hover:bg-muted"},null,8,["inputs","formFields"])],512),[[xt,e(F)]]),e(i).length===0&&e(F)?(n(),m("div",Da,[u(M,{color:"primary",class:"w-full justify-center",onClick:Ke},{default:f(()=>[a("span",null,_(e(C)("ai-agent.frontend.chat.startConversation")),1)]),_:1})])):y("",!0)])):y("",!0)]),_:1},8,["has-more"])]),_:1},512),a("div",Ra,[e(s).quickCommands?.length?(n(),m("div",ja,[a("div",Na,[(n(!0),m(z,null,E(e(s).quickCommands,r=>(n(),$(M,{key:r.name,color:"neutral",variant:"soft",size:"sm",onClick:P=>ie(r.name)},{default:f(()=>[r.avatar?(n(),$(at,{key:0,src:r.avatar,class:"h-4 w-4"},null,8,["src"])):y("",!0),a("span",null,_(r.name),1)]),_:2},1032,["onClick"]))),128))])])):y("",!0),u(st,{modelValue:e(p),"onUpdate:modelValue":o[4]||(o[4]=r=>ue(p)?p.value=r:null),"file-list":e(ee),"onUpdate:fileList":o[5]||(o[5]=r=>ue(ee)?ee.value=r:null),"is-loading":e(ge),placeholder:e(C)("ai-chat.frontend.and",{name:e(s).name}),attachmentSizeLimit:e(V)?.attachmentSizeLimit,"model-features":e(s).modelFeatures,class:"sticky bottom-0 z-10 [view-transition-name:chat-prompt]",rows:1,onStop:e(we),onSubmit:ie},{"panel-right-item":f(()=>[(e(s).billingConfig?.price??0)>0?(n(),m("span",qa,_(e(C)("ai-chat.frontend.singleRunConsumption",{price:e(s).billingConfig?.price??0})),1)):y("",!0)]),_:1},8,["modelValue","file-list","is-loading","placeholder","attachmentSizeLimit","model-features","onStop"])])],64)):y("",!0)],2)],2)}}});export{ds as _};

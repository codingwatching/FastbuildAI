import{aj as u,as as m,c4 as w}from"#entry";import{S as c}from"./td2xDKru.js";async function p({file:t,...o},i){const r=u();try{const{signature:e,fullPath:f,fileUrl:S,metadata:d}=await r.getOSSSignature(o),s=new FormData;s.append("key",f),s.append("success_action_status","200"),s.append("policy",e.policy),s.append("x-oss-signature",e.signature),s.append("x-oss-signature-version",e.ossSignatureVersion),s.append("x-oss-credential",e.ossCredential),s.append("x-oss-date",e.ossDate),s.append("x-oss-security-token",e.securityToken),s.append("file",t);const n=new XMLHttpRequest;return new Promise((g,l)=>{i?.onProgress&&n.upload.addEventListener("progress",a=>{if(a.lengthComputable){const y=Math.round(a.loaded/a.total*100);i.onProgress?.(y,a.loaded)}}),n.addEventListener("load",()=>{if(n.status>=200&&n.status<300)g({id:"",type:"",url:S,originalName:d.originalName,size:d.size,extension:d.extension});else{const a=new Error(`OSS upload failed: ${n.status} ${n.statusText}`);l(a)}}),n.addEventListener("error",()=>{const a=new Error("OSS upload network error");l(a)}),n.addEventListener("abort",()=>{const a=new Error("OSS upload has been cancelled");l(a)}),n.open("POST",e.host),n.send(s)})}catch(e){throw console.error("[Upload] OSS upload failed: ",e),e}}async function P(t,o){return t.files.reduce((r,e)=>r+e.size,0),await Promise.all(t.files.map(r=>{const e={file:r,size:r.size,name:r.name};return t.extensionId&&(e.extensionId=t.extensionId),o?.onProgress,p(e)}))}function x(t,o){const i=new Set(Array.isArray(o)?o:[o]);return Object.fromEntries(Object.entries(t).filter(([r])=>!i.has(r)))}function h(t){if(t)return t;try{return m().public.pluginName}catch{return}}async function E(t,o){const i=u();try{let r=i.storageType;switch(r||(r=await i.checkStorageType()),r){case c.OSS:{const e=h(t.extensionId);return await p({...x(t,"description"),...e&&{extensionId:e},name:t.file.name,size:t.file.size},o)}case c.LOCAL:return await w(t,o)}return Promise.reject("Invalid storage type")}catch(r){throw console.error("[Upload] upload failed:",r),r}}export{P as a,p as f,h as g,x as o,E as u};

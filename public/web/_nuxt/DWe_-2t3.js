import{_ as me}from"./Y499mysc.js";import pe from"./4jjeIyfe.js";import{d as Y,k as Z,s as E,at as G,i as K,n as z,p as ee,f as M,o as j,w as T,t as _,_ as te,v as R,x as F,z as W,g as a,D,A as fe,l as ge,a8 as ve,j as he,cB as xe,aW as X,aN as be,q as ye,J as _e,c as we,y as Fe,r as V,C as q,ar as Ue}from"#entry";import{_ as se}from"./CCoSr_X_.js";import Le from"./cd55qm53.js";import{_ as Te}from"./shdu-Ndv.js";import{_ as ze}from"./Be9qZ8Md.js";import{j as Se,k as Ce}from"./C457VaE0.js";import{u as ke}from"./fhkze2Jn.js";import{u as J}from"./DWy_CFG9.js";import{u as Re}from"./BEK00iAE.js";import{_ as $e}from"./Bzv9SrOl.js";const Oe={class:"text-background text-xs whitespace-pre-line"},Ie={class:"p-3"},je={class:"flex items-center gap-2"},Ee=["accept","disabled"],Ve=Y({__name:"prompt-file-upload",props:{disabled:{type:Boolean},maxSize:{},accept:{},modelConfig:{},modelFeatures:{}},emits:["file-select","url-submit"],setup(e,{emit:m}){const l=m,u=e,w=ke(),S=Z("fileInputRefs"),i=E(""),p=E(!1),c=G(),{t:h}=K(),x=E([]),C=z(()=>u.modelFeatures?.length?u.modelFeatures:x.value.length>0?x.value:u.modelConfig?.options?.features?.length?u.modelConfig.options.features:w.selectedModel?.features||[]),U=async r=>{if(u.modelFeatures?.length){x.value=[];return}if(!r){x.value=[];return}try{const o=await Se(r);x.value=o?.features||[]}catch(o){console.error("获取模型信息失败:",o),x.value=[]}};ee(()=>u.modelConfig?.id,r=>U(r),{immediate:!0});const L=z(()=>{if(!u.modelFeatures?.length&&!u.modelConfig&&!w.selectedModel)return".pdf,.doc,.docx,.txt,.md";const r=C.value||[],o=[],f=[".pdf",".docx",".txt",".md",".rtf",".csv",".xlsx",".xls",".pptx"];return o.push(...f),r.includes("vision")&&o.push(".jpg",".jpeg",".png",".gif",".webp",".bmp"),r.includes("audio")&&o.push(".mp3",".wav",".flac",".aac",".ogg",".m4a"),o.join(",")}),t=z(()=>{const o=u.maxSize||100,f=C.value.includes("vision"),y=h("common.chat.messages.uploadAttachmentTextOnly"),k=h("common.chat.messages.fileUploadLimit",{count:10,size:o}),$=f?h("common.chat.messages.supportsImage"):"";return`${y}
${k}${$}`}),s=()=>{p.value=!1,S.value?.click()};function d(r){const o=r.target,f=o.files?.[0];f&&l("file-select",f),o.value=""}function g(r){try{const y=new URL(r).pathname.split(".").pop()?.toLowerCase()||"";return y?`.${y}`:""}catch{const o=r.split(".").pop()?.toLowerCase()||"";return o?`.${o}`:""}}function v(r){return r?L.value.split(",").map(f=>f.trim()).includes(r.toLowerCase()):!1}function N(){const r=i.value.trim();if(!r)return;try{new URL(r)}catch{c.error(h("common.message.invalidUrl"));return}const o=g(r);if(!v(o)){c.error(h("common.message.unsupportedFileType"));return}l("url-submit",r),i.value="",p.value=!1}return(r,o)=>{const f=te,y=se,k=Le,$=Te,A=ze;return j(),M(A,{open:a(p),"onUpdate:open":o[2]||(o[2]=O=>D(p)?p.value=O:null)},{content:T(()=>[F("div",Ie,[F("div",null,[_(k,{modelValue:a(i),"onUpdate:modelValue":o[1]||(o[1]=O=>D(i)?i.value=O:null),ui:{root:"w-full",trailing:"!pe-0 !pr-1"},placeholder:a(h)("common.chat.messages.inputUrlPlaceholder")},{trailing:T(()=>[_(f,{size:"xs",onClick:R(N,["stop"])},{default:T(()=>[fe(W(a(h)("common.confirm")),1)]),_:1})]),_:1},8,["modelValue","placeholder"])]),_($,{class:"my-2",ui:{container:"text-xs font-normal text-muted-foreground"},label:"OR"}),F("div",je,[_(f,{size:"sm",label:a(h)("common.upload"),ui:{base:"flex-1 justify-center"},icon:"i-lucide-cloud-upload",variant:"outline",disabled:e.disabled,onClick:s},null,8,["label","disabled"])]),F("input",{ref_key:"fileInputRefs",ref:S,type:"file",accept:e.accept||a(L),class:"hidden",disabled:e.disabled,onChange:d},null,40,Ee)])]),default:T(()=>[_(y,{"delay-duration":0,ui:{content:"w-xs h-auto"}},{content:T(()=>[F("div",Oe,W(a(t)),1)]),default:T(()=>[_(f,{onClick:o[0]||(o[0]=R(()=>{},["stop"])),size:"lg",variant:"ghost",icon:"i-lucide-paperclip",class:"rounded-full font-bold",disabled:e.disabled},null,8,["disabled"])]),_:1})]),_:1},8,["open"])}}}),Me=["jpg","jpeg","png","gif","bmp","webp","svg"],Ne=["mp4","webm","ogg","mov","avi","wmv","flv","mkv"],Ae=["mp3","wav","ogg","m4a","aac","flac","wma"],Pe=e=>e.extension?e.extension.toLowerCase():(e.name||e.originalName||"").split(".").pop()?.toLowerCase()||"",Q=(e,m,l)=>{const u=Pe(e),w=e.type?.toLowerCase()||"";return m.includes(u)||w.startsWith(l)},Be=e=>Q(e,Me,"image/"),De=e=>Q(e,Ne,"video/"),Ge=e=>Q(e,Ae,"audio/"),H=e=>Be(e)?"image":De(e)?"video":Ge(e)?"audio":"file";function Ke(){const{t:e}=K(),m=G(),l=ge([]),u=z(()=>l.value.some(t=>t.status==="uploading")),w=()=>`${Date.now()}-${Math.random().toString(36).slice(2,11)}`,S=t=>l.value.find(s=>s.id===t),i=(t,s)=>{const d=S(t);d&&Object.assign(d,s)},p=t=>{t.startsWith("blob:")&&URL.revokeObjectURL(t)},c=async t=>{const s=w(),d=URL.createObjectURL(t);l.value.push({id:s,name:t.name,size:t.size,url:d,progress:0,status:"uploading",mediaType:H(t),file:t});try{const g=await J({file:t,description:`Prompt file: ${t.name}`},{onProgress:v=>i(s,{progress:v})});return p(d),i(s,{status:"success",progress:100,url:g.url,result:g}),m.success(e("common.message.uploadSuccess")),g}catch(g){return console.error("File upload failed:",g),i(s,{status:"error",error:g instanceof Error?g.message:e("common.message.uploadFailed")}),m.error(e("common.message.uploadFailed")),null}},h=async t=>{try{new URL(t.trim())}catch{return m.error(e("common.message.invalidUrl")),!1}const s=`url-${w()}`,d=t.trim(),g=d.split("/").pop()||"Remote File";l.value.push({id:s,name:g,size:0,url:d,progress:0,status:"uploading",mediaType:"image"});try{const v=await Re({url:d,description:`Remote file: ${g}`});return i(s,{status:"success",progress:100,url:v.url,size:v.size,name:v.originalName,mediaType:H(v),result:v}),m.success(e("common.message.urlAdded")),!0}catch(v){return i(s,{status:"error",error:v instanceof Error?v.message:e("common.message.uploadFailed")}),m.error(e("common.message.uploadFailed")),!1}},x=t=>{const s=l.value.findIndex(d=>d.id===t.id);s!==-1&&(p(l.value[s]?.url??""),l.value.splice(s,1))},C=()=>{l.value.forEach(t=>p(t.url)),l.value=[]},U=async t=>{if(!t.file)return m.error(e("common.message.fileNotFound")),null;Object.assign(t,{status:"uploading",progress:0,error:void 0});try{const s=await J({file:t.file,description:`Prompt file: ${t.file.name}`},{onProgress:d=>t.progress=d});return p(t.url),Object.assign(t,{status:"success",progress:100,url:s.url,result:s}),m.success(e("common.message.uploadSuccess")),s}catch(s){return console.error("File upload failed:",s),Object.assign(t,{status:"error",error:s instanceof Error?s.message:e("common.message.uploadFailed")}),m.error(e("common.message.uploadFailed")),null}},L=()=>l.value.filter(t=>t.status==="success"&&t.result).map(t=>{switch(t.mediaType){case"image":return{type:"image_url",image_url:{url:t.url}};case"video":return{type:"video_url",video_url:{url:t.url}};case"audio":{const s=t.name.split(".").pop()?.toLowerCase()||"mp3";return{type:"input_audio",input_audio:{data:t.url,format:s}}}default:return{type:"file_url",name:t.name,url:t.url}}});return{files:ve(l),isUploading:u,uploadFile:c,addUrl:h,removeFile:x,clearFiles:C,retryUpload:U,generateFilesList:L}}const Qe={class:"flex items-center gap-2"},We={class:"flex items-end justify-between p-0 sm:p-2"},Xe={class:"flex items-center gap-2"},qe={class:"flex items-center gap-2"},Je=Y({__name:"chats-prompt",props:{modelValue:{default:""},fileList:{default:()=>[]},placeholder:{default:""},isLoading:{type:Boolean,default:!1},rows:{default:1},needAuth:{type:Boolean,default:!1},attachmentSizeLimit:{default:10},modelConfig:{},modelFeatures:{}},emits:["update:modelValue","update:fileList","submit","stop"],setup(e,{emit:m}){const l=m,u=e,w=Z("uTextareaRefs"),S=z(()=>w.value?.textareaRef||null),i=X(u,"modelValue",l),p=X(u,"fileList",l),{t:c}=K(),h=he(),x=G(),{focused:C}=xe(S,{initialValue:!1}),U=E(""),L=E(""),t=z(()=>L.value!==""&&i.value.trim()===L.value.trim()),{files:s,isUploading:d,uploadFile:g,addUrl:v,removeFile:N,retryUpload:r,generateFilesList:o,clearFiles:f}=Ke(),y=z(()=>i.value.trim().length>0||s.value.length>0);function k(){w.value?.textareaRef?.focus(),!h.isAgreed&&u.needAuth&&Ue("/login")}function $(n){if(!n.isComposing&&n.key==="Enter"&&!n.shiftKey){if(n.preventDefault(),!y.value)return;u.isLoading?l("stop"):l("submit",i.value)}}function A(){if(u.isLoading)l("stop");else{if(!y.value)return;l("submit",i.value)}}async function O(n){await g(n)&&(p.value=o())}async function oe(n){await v(n)&&(p.value=o())}function ae(n){"id"in n&&(N(n),p.value=o())}async function ne(n){"id"in n&&await r(n)&&(p.value=o())}const{lockFn:ie,isLock:I}=be(async()=>{if(!i.value.trim()){x.warning(c("common.chat.messages.enterQuestion"));return}if(!u.isLoading)try{U.value=i.value.trim();const n=localStorage.getItem("modelId")||void 0,b=await Ce({modelId:n,text:U.value});b.optimizedText?(L.value=b.optimizedText,i.value=b.optimizedText,x.success(c("common.chat.messages.optimizeSuccess"))):x.warning(c("common.chat.messages.optimizeEmpty"))}catch(n){console.error("文案优化失败:",n);const b=n?.message||c("common.chat.messages.optimizeFailed");x.error(b)}});function re(){U.value&&(i.value=U.value,L.value="",U.value="")}return ee(()=>u.fileList,n=>{n.length===0&&s.value.length>0&&f()}),ye(()=>_e(()=>{h.isAgreed&&k()})),(n,b)=>{const le=me,ue=pe,P=te,B=se,ce=Ve;return j(),we("div",{class:q(["chat-action-bar w-full rounded-md border p-1.5 transition-[border-color_box-shadow] duration-200 sm:rounded-2xl",a(C)?"ring-primary/15 border-primary ring-3":"border-border"]),onClick:R(k,["stop"])},[F("div",Qe,[V(n.$slots,"panel-top",{},void 0,!0)]),a(s).length>0?(j(),M(le,{key:0,files:[...a(s)],"show-actions":!0,class:"p-1.5",onRemove:ae,onRetry:ne},null,8,["files"])):Fe("",!0),_(ue,{ref_key:"uTextareaRefs",ref:w,modelValue:a(i),"onUpdate:modelValue":b[0]||(b[0]=de=>D(i)?i.value=de:null),class:q(["custom-textarea-wrapper w-full",{"optimizing-text":a(I)}]),style:{"--ui-bg-elevated":"var(--color-background)"},variant:"ghost",rows:e.rows,maxrows:8,highlight:!1,autoresize:!0,ui:{base:"resize-none custom-textarea text-base min-h-[40px] focus:bg-transparent hover:bg-transparent"},placeholder:e.placeholder||a(c)("common.chat.messages.inputPlaceholder"),disabled:a(I),onKeydown:$},null,8,["modelValue","class","rows","placeholder","disabled"]),F("div",We,[F("div",Xe,[V(n.$slots,"panel-left",{},()=>[b[1]||(b[1]=F("div",null,null,-1))],!0)]),V(n.$slots,"panel-right",{},()=>[F("div",qe,[a(t)?(j(),M(B,{key:0,text:a(c)("common.chat.messages.revertText"),"delay-duration":0,arrow:!0},{default:T(()=>[_(P,{icon:"i-lucide-undo-2",class:"rounded-full font-bold",size:"lg",variant:"ghost",color:"primary",disabled:u.isLoading,onClick:R(re,["stop"])},null,8,["disabled"])]),_:1},8,["text"])):(j(),M(B,{key:1,text:a(I)?a(c)("common.chat.messages.optimizing"):a(i)?.trim()?a(c)("common.chat.messages.optimizeText"):a(c)("common.chat.messages.enterQuestion"),"delay-duration":0,arrow:!0},{default:T(()=>[_(P,{icon:"i-lucide-sparkles",class:"rounded-full font-bold",size:"lg",variant:"ghost",color:"primary",disabled:a(I)||!a(i)?.trim()||u.isLoading,loading:a(I),onClick:R(a(ie),["stop"])},null,8,["disabled","loading","onClick"])]),_:1},8,["text"])),_(ce,{disabled:a(d),maxSize:e.attachmentSizeLimit,"model-config":e.modelConfig,"model-features":e.modelFeatures,onFileSelect:O,onUrlSubmit:oe},null,8,["disabled","maxSize","model-config","model-features"]),V(n.$slots,"panel-right-item",{},void 0,!0),_(B,{content:{align:"center",side:"top",sideOffset:8},text:e.isLoading?a(c)("common.chat.messages.stopGeneration"):a(y)?a(c)("common.chat.messages.sendMessage"):a(c)("common.chat.messages.enterQuestion"),"delay-duration":0,arrow:!0,disabled:e.isLoading||a(y)},{default:T(()=>[_(P,{icon:e.isLoading?"i-lucide-square":"i-lucide-arrow-up",class:"rounded-full font-bold",size:"lg",disabled:!e.isLoading&&!a(y),color:e.isLoading?"error":"primary",onClick:R(A,["stop"])},null,8,["icon","disabled","color"])]),_:1},8,["text","disabled"])])],!0)])],2)}}}),He=$e(Je,[["__scopeId","data-v-b40103be"]]),ct=Object.freeze(Object.defineProperty({__proto__:null,default:He},Symbol.toStringTag,{value:"Module"}));export{He as _,Ge as a,ct as c,H as g,De as i};

const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./C4NGHR0z.js","./Dgvg0_To.js","./BjYsydzc.js","./Brlt-NDg.js","./DoL5-2Ox.js","./Dp8axn_r.js","./6WwfWHXT.js","./KiG0a5S-.js","./CXk2IlXx.js","./kRIii9yh.js","./DBwQYu6J.js","./B1TeSxwV.js","./C6Y-ieo6.js","./Ti3HjCpC.js","./CyS2mNdj.js","./BaKvIqXP.js","./cwT2REE1.js","./DaC7Nksz.js","./DegKy-XA.js","./DnFVE45b.js","./DSCppvl0.js","./7d3iyZ8h.js","./N6rGDb75.js","./BMSQkwth.js","./DaWZu8wl.js","./DyTskiS5.js","./DVSiT9pd.js","./D_1uxSdv.js","./Ds48qA85.js","./BYm23QKU.js","./DGUAW_1C.js","./DDJ79SjH.js","./RmzZBBRE.js","./C4jlvBh2.js","./C-XPfH0G.js","./ChM0pAjz.js","./D-hk-k_E.js","./BUyfW8JT.js","./nDlVuOVH.js","./CR9qioUt.js","./BRI4D6WA.js","./DlAUqK2U.js","./DKglrQ_X.js","./CDSfhndf.js","./12pJH7Js.js","./BstbYvQo.js"])))=>i.map(i=>d[i]);
import{d as fe,aJ as ge,f as O,e as ve,ap as _e,g as he,aO as ke,Q as ye,i as D,s as M,aT as be,w as Ce,H as Q,j as we,ag as xe,c as u,o as r,k,v as g,m,t as p,q as n,R as T,l as _,x as y,F as A,C as U,_ as Ie,z as Se,B as Fe,U as P,aW as Ae}from"#entry";import{_ as Ee}from"./C7KE9iN2.js";import{_ as Re,a as Ve}from"./BJKUFT5l.js";import{_ as $e}from"./CGkf3lDq.js";import{_ as Be}from"./Bu0wbSuB.js";import{_ as Me}from"./CR9qioUt.js";import{_ as Te}from"./DH5Wu3SI.js";import{p as Ue,o as Pe}from"./ChM0pAjz.js";import{u as Le}from"./gmT0rIzw.js";import"./BMSQkwth.js";import"./DaWZu8wl.js";import"./DxdFW9IF.js";import"./B-p4_8pw.js";import"./CsY35JUW.js";import"./DBwQYu6J.js";import"./DnFVE45b.js";import"./DegKy-XA.js";import"./DSCppvl0.js";import"./7d3iyZ8h.js";import"./CjOovgR0.js";import"./DXP7Kkdt.js";import"./BRI4D6WA.js";import"./CHCbUdJ4.js";import"./BI1JbAYD.js";import"./CyWWYgEs.js";import"./BixMXl5t.js";import"./CvZB4bI9.js";import"./KiG0a5S-.js";import"./CXk2IlXx.js";import"./kRIii9yh.js";import"./B1TeSxwV.js";import"./C6Y-ieo6.js";import"./Ti3HjCpC.js";import"./CyS2mNdj.js";import"./BaKvIqXP.js";import"./cwT2REE1.js";import"./DaC7Nksz.js";import"./Dx01Lm3C.js";import"./DlAUqK2U.js";import"./BjYsydzc.js";import"./CDSfhndf.js";import"./t1d_OU1Q.js";import"./DPwLTNIs.js";const qe={class:"flex h-full min-h-0 w-full flex-col"},Oe={class:"flex flex-col gap-2"},De={class:"text-muted-foreground text-sm"},Qe={key:0,class:"flex items-center gap-2"},ze={class:"my-2 flex items-center gap-1"},Ne={class:"text-muted-foreground flex-none text-xs"},He={key:1,class:"mt-2 flex items-center gap-1"},je={class:"text-muted-foreground flex-none text-xs"},Je={key:1,class:"mb-2 space-y-2"},Ke={class:"px-4 pb-4"},We={class:"flex gap-2 pb-4"},Ot=fe({__name:"preview-chat",props:{agent:{},showVariableInput:{type:Boolean}},emits:["update:agent"],setup(d,{expose:z,emit:N}){const H=T(()=>P(()=>import("./C4NGHR0z.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37]),import.meta.url)),j=T(()=>P(()=>import("./nDlVuOVH.js"),__vite__mapDeps([38,39,1,40,41,29,30,31,13,18,11,32,33,34,21]),import.meta.url)),J=T(()=>P(()=>import("./DKglrQ_X.js"),__vite__mapDeps([42,43,1,3,4,2,44,8,26,10,13,14,15,11,45,18,28,37,24]),import.meta.url)),K=N,W=d,{params:G}=ge(),X=O(),{t:s}=ve(),x=_e(),b=he("scrollAreaRef"),{height:Y}=ke(b),L=ye(),o=be(W,"agent",K),I=D(()=>G.id),E=M(null),Z=[],ee=M([]),{messages:l,input:R,handleSubmit:te,reload:ae,stop:ne,status:oe,error:re}=Le({api:Ue,initialMessages:Z,chatConfig:{get avatar(){return o.value.chatAvatar}},body:{agentId:I.value,saveConversation:!1,get conversationId(){return E.value},get modelConfig(){return o.value.modelConfig},get mcpServerIds(){return o.value.mcpServerIds},get datasetIds(){return o.value.datasetIds},get rolePrompt(){return o.value.rolePrompt},get showContext(){return o.value.showContext},get showReference(){return o.value.showReference},get enableFeedback(){return o.value.enableFeedback},get autoQuestions(){return o.value.autoQuestions},get formFields(){return o.value.formFields},get formFieldsInputs(){return o.value.formFieldsInputs},get quickCommands(){return o.value.quickCommands},get thirdPartyIntegration(){return o.value.thirdPartyIntegration}},onToolCall(){},onResponse(a){a.status===401&&O().logout(!0)},onUpdate(a){a.type==="conversation_id"&&(E.value=a.data)},onError(a){const t=a?.message||"发送失败";console.error("聊天错误:",t)},onFinish(){}}),S=D(()=>oe.value==="loading"),V=M(!0);function $(a){const t=a.target,c=40;V.value=t.scrollHeight-(t.scrollTop+t.clientHeight)<=c}async function C(a=!0){await Q(),b.value?.scrollToBottom(a)}async function F(a){if(!a.trim()||S.value)return;if(!o.value.modelConfig?.id&&o.value.createMode==="direct")return x.warning(s("ai-agent.backend.configuration.modelNotConfigured"));const t=o.value.formFields||[],c=o.value.formFieldsInputs||{};if(t.length>0){const i=[];if(t.forEach(h=>{if(h.required){const w=c[h.name];(!w||typeof w=="string"&&w.trim()==="")&&i.push(`${h.label}${s("ai-agent.backend.configuration.notEmpty")}`)}}),i.length>0){x.error(`${s("ai-agent.backend.configuration.formVariableTitle")}: ${i.join(", ")}`);return}}await te(a),C()}const se=a=>{ee.value=a,L.create(j).open({context:a})},ie=(a,t=null)=>{L.create(H).open({agentId:I.value,annotationId:a,messageId:t,hiddenStatus:!0})};async function le(a,t){const c=l.value[t-1];if(!c||c.role!=="user"){x.error(s("ai-agent.backend.configuration.noUserQuestion"));return}try{const i=await Pe(I.value,{agentId:I.value,question:c.content.toString(),answer:a.content.toString(),enabled:!0,messageId:a.id});l.value[t]?.metadata||l.value[t]&&(l.value[t].metadata={}),l.value[t]?.metadata&&(l.value[t].metadata.annotations={annotationId:i.id,createdBy:X.userInfo?.nickname,question:i.question,similarity:1})}catch(i){console.error("创建标注失败:",i)}}Ce(()=>l.value.at(-1)?.content,()=>Q(()=>{V.value&&C(!1)}),{flush:"post"});let B=null;return we(async()=>{C(!1);const a=b.value?.getViewportElement(),t=a&&a.viewportElement;t?.addEventListener("scroll",$,{passive:!0}),t&&($({target:t}),B=new MutationObserver(()=>{V.value&&C(!1)}),B.observe(t,{childList:!0,subtree:!0,characterData:!0}))}),xe(()=>{const a=b.value?.getViewportElement();(a&&a.viewportElement)?.removeEventListener("scroll",$),B?.disconnect()}),z({clearRecord(){l.value=[],E.value=null}}),(a,t)=>{const c=Ee,i=Ie,h=Ve,w=Se,q=$e,ce=Be,ue=Re,me=Me,de=Ae,pe=Te;return r(),u("div",qe,[d.showVariableInput&&n(o).formFields&&n(o).formFields.length>0?(r(),k(n(J),{key:0,inputs:n(o).formFieldsInputs,"onUpdate:inputs":t[0]||(t[0]=e=>n(o).formFieldsInputs=e),formFields:n(o).formFields,class:"mx-4 mt-2",formClass:"bg-muted hover:bg-muted"},null,8,["inputs","formFields"])):g("",!0),m(me,{class:"min-h-0 w-full flex-1",type:"auto",ref_key:"scrollAreaRef",ref:b,onInView:t[1]||(t[1]=e=>C(!1))},{default:_(()=>[m(ue,{loading:!1,"has-more":!1,threshold:500,"content-class":"w-full space-y-3 p-4 "},{default:_(()=>[n(l).length===0?(r(),k(h,{key:0,messages:[{role:"assistant",avatar:d.agent.chatAvatar,content:d.agent.openingStatement}],"scroll-area-height":200,assistant:{actions:[]}},{content:_(({message:e})=>[m(c,{content:e.content.toString(),class:"mb-2"},null,8,["content"]),p("div",Oe,[p("div",De,y(n(s)("ai-agent.backend.configuration.youCanAskMe")),1),(r(!0),u(A,null,U(d.agent.openingQuestions,f=>(r(),u("div",{key:f},[m(i,{label:f,color:"primary",variant:"soft",onClick:v=>F(f)},null,8,["label","onClick"])]))),128))])]),_:1},8,["messages"])):(r(),k(h,{key:1,messages:n(l),"scroll-area-height":n(Y),error:n(re),assistant:{actions:[{label:n(s)("ai-chat.frontend.messages.retry"),icon:"i-lucide-rotate-cw-square",onClick:()=>n(ae)()},{label:n(s)("ai-agent.backend.configuration.chatContext"),icon:"i-lucide-file-type",show:!d.agent.showContext,onClick:e=>{e?.metadata?.context?se(e.metadata.context):n(x).error(n(s)("ai-agent.backend.configuration.noChatContext"))}},{label:n(s)("ai-agent.backend.configuration.feedback"),icon:"i-lucide-wrap-text",show:!d.agent.enableFeedback,onClick:(e,f)=>{const v=e.metadata?.annotations?.annotationId;v?ie(v,e.id):le(e,f)}}]},"spacing-offset":160},{content:_(({message:e,index:f})=>[e.content.length||e.metadata?.references&&e.metadata.references.length?(r(),k(c,{key:0,content:e.content.toString()},{before:_(()=>[e.status==="loading"?(r(),u("div",Qe,[m(w,{name:"i-lucide-loader-2",class:"animate-spin"}),p("span",null,y(n(s)("ai-chat.frontend.messages.thinking")),1)])):g("",!0)]),after:_(()=>[e.metadata?.references&&e.metadata.references.length>0&&e.role==="assistant"&&!n(S)&&d.agent.showReference?(r(),u(A,{key:0},[p("div",ze,[p("span",Ne,y(n(s)("ai-agent.backend.configuration.referenceTitle")),1),e.metadata?.references&&e.metadata.references.length>0&&e.role==="assistant"?(r(),k(q,{key:0,size:"xs",type:"dashed"})):g("",!0)]),m(ce,{references:e.metadata.references},null,8,["references"])],64)):g("",!0),e.metadata?.annotations&&e.role==="assistant"&&!n(S)?(r(),u("div",He,[p("span",je,y(e.metadata?.annotations?.createdBy)+" "+y(n(s)("ai-agent.backend.configuration.editedAnswer")),1),m(q,{size:"xs",type:"dashed"})])):g("",!0)]),_:2},1032,["content"])):g("",!0),e.metadata?.suggestions&&n(l).length-1===f?(r(),u("div",Je,[(r(!0),u(A,null,U(e.metadata.suggestions,v=>(r(),u("div",{key:v},[m(i,{label:v,color:"primary",variant:"soft",onClick:Ge=>F(v)},null,8,["label","onClick"])]))),128))])):g("",!0)]),_:1},8,["messages","scroll-area-height","error","assistant"]))]),_:1})]),_:1},512),p("div",Ke,[p("div",We,[(r(!0),u(A,null,U(d.agent.quickCommands,e=>(r(),u("div",{key:e.name},[m(i,{color:"neutral",variant:"soft",onClick:f=>F(e.content)},{default:_(()=>[e.avatar?(r(),k(de,{key:0,src:e.avatar,class:"h-4 w-4"},null,8,["src"])):g("",!0),p("span",null,y(e.name),1)]),_:2},1032,["onClick"])]))),128))]),m(pe,{modelValue:n(R),"onUpdate:modelValue":t[2]||(t[2]=e=>Fe(R)?R.value=e:null),"is-loading":n(S),class:"sticky bottom-0 z-10 [view-transition-name:chat-prompt]",onStop:n(ne),onSubmit:F},null,8,["modelValue","is-loading","onStop"])])])}}});export{Ot as default};
